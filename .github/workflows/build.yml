name: 🧱 Build DLL & release (Windows)

env:
    PLUGIN_NAME: PluginUpdater
    TAG_NAME: ${{ github.event.inputs.tag || github.ref_name }}

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:
        inputs:
            tag:
                description: "Release tag (e.g. v1.0.1)"
                required: true
permissions:
    contents: write

jobs:
    check-changelog:
        name: Check changelog (main)
        runs-on: windows-latest
        outputs:
            changelog: ${{ steps.changelog.outputs.changelog }}
        steps:
            - name: 📥 Checkout repository (main)
              uses: actions/checkout@v4
              with:
                  ref: main
                  submodules: false

            - name: 📝 Extract changes from changelog
              id: changelog
              shell: bash
              run: |
                  # Prefer manual input if available
                  TAG="${{ github.event.inputs.tag || github.ref_name }}"

                  # fail if tag not found in CHANGELOG.md
                  if ! grep -q "^## $TAG" CHANGELOG.md; then
                    echo "❌ Tag '$TAG' not found in CHANGELOG.md"
                    exit 1
                  fi

                  echo "Using tag: $TAG"

                  NOTES=$(awk "/^## $TAG/{flag=1; next} /^## /{flag=0} flag" CHANGELOG.md)

                  echo "Extracted notes:"
                  echo "$NOTES"

                  {
                    echo "changelog<<EOF"
                    echo "$NOTES"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

    build:
        name: Build DLL
        needs: check-changelog
        runs-on: windows-latest # uses pwsh (PowerShell Core) as default shell

        steps:
            - name: 📥 Checkout repository (without submodules)
              uses: actions/checkout@v4
              with:
                  submodules: false

            - name: 🍆 Initialize submodules
              run: ./scripts/init-submodules.bat

            - name: 🪟 Set up MSVC
              uses: ilammy/msvc-dev-cmd@v1

            - name: 🥷 Set up Ninja
              uses: seanmiddleditch/gha-setup-ninja@v3

            - name: ⚙️ Set up CMake
              uses: jwlawson/actions-setup-cmake@v1

            - name: 🧱 Configure using CMake preset
              run: cmake --preset windows-x64-msvc

            - name: 🔨 Build using CMake preset
              run: cmake --build --preset default

            - name: 🚀 Create release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ env.TAG_NAME }}
                  body: |
                      ## Install Steps
                      1. Close Rocket League
                      2. Download `${{ env.PLUGIN_NAME }}.dll` below
                      3. Put it in your bakkesmod plugins folder

                      ## Notes
                      ${{ needs.check-changelog.outputs.changelog }}
                  files: plugins/*.dll
